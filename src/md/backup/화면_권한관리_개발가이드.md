# 화면/메뉴 권한 관리 시스템 개발 가이드

본 문서는 사용자 식별자(이메일)를 기반으로 왼쪽 사이드바 메뉴의 접근 권한을 제어하는 시스템의 구현 가이드입니다.
Google Sheets의 `auth_menu_mgt` 탭을 권한 관리의 원천 데이터(Source of Truth)로 사용합니다.

---

## 1. 개요 (Overview)

*   **목표**: 사용자별로 노출되는 메뉴를 동적으로 제어하고, 권한이 없는 페이지로의 접근을 차단합니다.
*   **대상**: 왼쪽 사이드바 메뉴 전체 (Dashboard, Investment, Code Management 등)
*   **제어 방식**:
    1.  **UI 은닉**: 권한이 없는 메뉴는 사이드바에서 보이지 않음.
    2.  **접근 차단**: URL 직접 접근 시 권한 확인 후 차단 (Redirect).
*   **관리 도구**: Google Sheets (`auth_menu_mgt` 탭)

---

## 2. 데이터 스키마 (Google Sheet)

두 개의 시트(탭)를 사용하여 **메뉴 정의(Master)**와 **사용자 권한(Detail)**을 관리합니다.

### 2.1 메뉴 정의 시트 (`menu_def_mgt`) - **New!**
시스템 전체의 메뉴 목록을 정의합니다. 메뉴 순서나 이름을 개발자 없이 변경할 수 있습니다.

| 컬럼명 | 설명 | 예시 데이터 | 비고 |
| :--- | :--- | :--- | :--- |
| **uuid** | 고유 식별자 | `123e4567-e89b...` | **System PK (필수)** |
| **menu_code** | 메뉴 식별 코드 | `investment` | **Logical Key** |
| **label_key** | 다국어 키 또는 메뉴명 | `investment` (또는 투자관리) | `t[label_key]`로 매핑 |
| **path** | 라우트 경로 | `/investment` | |
| **icon_name** | 아이콘 이름 | `TrendingUp` | Lucide 아이콘명 문자열 |
| **sort_order** | 정렬 순서 | `2` | 숫자 |
| **use_yn** | 메뉴 사용 여부 | `Y` | 전체 비활성화 용도 |
| **location** | 메뉴 위치 | `sidebar` | `sidebar` 또는 `bottom` |

### 2.2 사용자 권한 시트 (`auth_menu_mgt`)
사용자별로 특정 메뉴의 접근 권한을 매핑합니다.

| 컬럼명 | 설명 | 예시 데이터 | 비고 |
| :--- | :--- | :--- | :--- |
| **uuid** | 고유 식별자 | `123e4567-e89b...` | **System PK (필수)** |
| **user_email** | 사용자 ID (이메일) | `test@user.com` | **Key** |
| **menu_code** | 메뉴 식별 코드 | `investment` | `menu_def_mgt`와 매핑 |
| **access_yn** | 접근 허용 여부 | `Y` | `N`이면 숨김/차단 |

---

## 3. 구현 상세 가이드 (Implementation Steps)

### Step 1: Google Sheet 데이터 입력
1.  **`menu_def_mgt`**: 모든 메뉴(`dashboard`, `shop`, `codes` 등)를 정의합니다.
2.  **`auth_menu_mgt`**: 사용자별 권한을 정의합니다. (데이터가 없는 메뉴는 기본적으로 '접근 불가'로 처리하거나 '기본값' 정책을 정해야 합니다.)

### Step 2: Backend
*   수정 불필요 (`api/sheets/data`를 통해 `menu_def_mgt`, `auth_menu_mgt` 각각 호출 가능)

### Step 3: Frontend - 데이터 로드 (`AuthContext` 또는 `MainLayout`)
앱 실행 시(또는 로그인 직후) 두 가지 데이터를 모두 가져와야 합니다.

1.  **`fetchMenuDefinitions`**: `menu_def_mgt` 조회 -> `use_yn === 'Y'`인 메뉴만 로드 & `sort_order` 정렬.
2.  **`fetchUserPermissions`**: `auth_menu_mgt` 조회 -> 내 이메일에 해당하는 `access_yn === 'Y'`인 `menu_code` 목록 확보.

### Step 4: Frontend - 아이콘 매핑 (String -> Component)
DB(시트)에는 아이콘을 "텍스트"(`Home`)로 저장하므로, 이를 실제 컴포넌트로 변환하는 맵퍼가 필요합니다.

```javascript
// util/iconMapper.js
import * as LucideIcons from 'lucide-react';

export const getIconComponent = (iconName) => {
    return LucideIcons[iconName] || LucideIcons.HelpCircle; // 기본값
};
```

### Step 5: Frontend - 동적 메뉴 렌더링 (`MainLayout`)
기존의 하드코딩된 `menuItems` 배열을 제거하고, 로드된 데이터를 기반으로 렌더링합니다.

```javascript
// 1. 메뉴 정의(menuDefs)와 내 권한(myPerms)을 결합 (Join)
const visibleMenus = menuDefs.filter(menu => {
    // A. 내 권한 목록에 있거나
    // B. (옵션) 'dashboard' 같은 공용 메뉴는 항상 허용하거나
    return myPerms.includes(menu.menu_code) || menu.menu_code === 'dashboard';
});

// 2. 렌더링
{visibleMenus.map(menu => {
    const Icon = getIconComponent(menu.icon_name);
    return (
        <button key={menu.menu_code} onClick={() => navigate(menu.path)}>
            <Icon size={20} />
            {t[menu.label_key] || menu.label_key}
        </button>
    );
})}
```

> **주의**: 하단에 하드코딩된 `Settings`, `Code Management` 버튼도 동일한 로직으로 조건부 렌더링(`{permissions.includes('code_mgmt') && <button...>}`) 해야 합니다.

### Step 5: Frontend - 접근 차단 (Route Protection)

UI에서 메뉴를 숨겨도 URL로 직접 접근(`http://.../codes`)하는 것을 막아야 합니다.
`ProtectedRoute.jsx` 또는 `App.jsx` 레벨에서 이를 처리하지 않고, 각 페이지 컴포넌트(`CodeManagement.jsx` 등) 진입 시 검사하거나,
`MainLayout`의 `useEffect`에서 URL 변경 시 권한을 체크하여 리다이렉트시키는 방법이 있습니다.

**추천 방식 (MainLayout 내 방어)**:
```javascript
useEffect(() => {
    // 현재 경로에 해당하는 메뉴 코드 찾기
    const currentMenu = allItems.find(item => item.path === location.pathname);
    if (currentMenu && !permissions.includes(currentMenu.code)) {
        alert("접근 권한이 없습니다.");
        navigate('/dashboard');
    }
}, [location.pathname, permissions]);
```

---

## 4. 테스트 시나리오

1.  **기본 권한 테스트**:
    *   A 사용자로 로그인.
    *   구글 시트에 '권한 Y'로 설정된 메뉴만 사이드바에 보이는지 확인.
2.  **권한 변경 반영**:
    *   구글 시트에서 A 사용자의 `investment` 권한을 `N`으로 변경.
    *   새로고침(또는 재로그인) 후 투자 관리 메뉴가 사라지는지 확인.
3.  **URL 직접 접근 방어**:
    *   권한이 없는 메뉴(예: `/codes`)의 URL을 주소창에 직접 입력.
    *   접근이 차단되고 대시보드로 리다이렉트되는지 확인.
4.  **로그아웃 후 초기화**:
    *   로그아웃 시 권한 정보(`permissions`)가 초기화되는지 확인.

---

## 5. 향후 확장 고려사항

*   **그룹 권한(Role Base)**: 사용자별 매핑이 번거로울 경우, `auth_group_mgt` 시트를 만들어 `ADMIN`, `USER` 그룹별 권한을 관리하고 사용자에게 그룹을 매핑하는 방식으로 고도화 가능.
*   **읽기/쓰기 권한 분리**: `read_only` 컬럼을 활용하여 메뉴 접근은 되지만 '저장/삭제' 버튼만 비활성화하는 기능 구현 가능.

---

## [부록] 초기 데이터셋 (Copy & Paste)

구글 시트에 바로 복사해서 사용할 수 있는 초기 데이터입니다.

### 1. `menu_def_mgt` (메뉴 정의)

| menu_code | label_key | path | icon_name | sort_order | use_yn | location |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| dashboard | dashboard | /dashboard | Home | 1 | Y | sidebar |
| my_monster | myMonster | /my-monster | User | 2 | Y | sidebar |
| leaderboard | leaderboard | /leaderboard | Trophy | 3 | Y | sidebar |
| shop | shop | /shop | ShoppingBag | 4 | Y | sidebar |
| notebook_lm | NotebookLM | /notebooks | Book | 5 | Y | sidebar |
| investment | investment | /investment | TrendingUp | 6 | Y | sidebar |
| friends | friends | /friends | Globe | 7 | Y | sidebar |
| code_mgmt | codeMgt | /codes | Tag | 98 | Y | bottom |
| settings | settings | /settings | Settings | 99 | Y | bottom |

### 2. `auth_menu_mgt` (사용자 권한)
*   **Target User**: `iam1000@gmail.com` (Super Admin)

| user_email | menu_code | access_yn | description |
| :--- | :--- | :--- | :--- |
| iam1000@gmail.com | dashboard | Y | 기본 대시보드 |
| iam1000@gmail.com | my_monster | Y | 마이 몬스터 |
| iam1000@gmail.com | leaderboard | Y | 리더보드 |
| iam1000@gmail.com | shop | Y | 상점 |
| iam1000@gmail.com | notebook_lm | Y | 학습 노트 |
| iam1000@gmail.com | investment | Y | 투자 관리 |
| iam1000@gmail.com | friends | Y | 친구 목록 |
| iam1000@gmail.com | code_mgmt | Y | 코드 관리 (관리자) |
| iam1000@gmail.com | settings | Y | 시스템 설정 |
