# 코드 매핑 가이드 (Code Mapping Guide)

## 1. 개요
본 문서는 Stitch 프로젝트에 구현된 **동적 데이터 매핑 시스템**에 대한 가이드입니다.
기존의 하드코딩된 옵션 대신, Google Sheets의 참조 데이터(`CODES`, `accounts_master` 등)를 실시간으로 가져와 화면에 매핑하는 방식을 설명합니다.

---

## 2. 주요 구성 요소

### 2.1. 설정 파일 (`src/config/mapping_rules.js`)
매핑 규칙을 화면 단위(`View ID`)로 정의하는 중앙 설정 파일입니다.

**규칙 구조 예시:**
```javascript
export const MAPPING_RULES = {
    // 화면 ID (View ID)
    "ACCOUNTS_MANAGER": [
        {
            "targetColumn": "account_type",  // [Main] 매핑할 원본 컬럼
            "mapping": {
                "type": "SHEET_JOIN",       // 매핑 방식
                "refSheet": "CODES",        // [Ref] 참조 시트명
                "refKey": "code_id",        // [Ref] 참조 키 컬럼 (PK)
                "displayColumn": "code_name", // [Ref] 표시할 컬럼 (Value)
                "filters": {                // [Optional] 참조 데이터 필터링 조건
                    "group_code": "ACCOUNT_TYPE",
                    "use_yn": "Y"
                }
            }
        }
    ]
};
```

### 2.2. 커스텀 훅 (`src/hooks/useDataMapper.js`)
설정된 규칙을 읽어 데이터를 페칭(Fetching)하고 변환하는 로직을 캡슐화한 Hook입니다.

**주요 반환 값:**
*   `getMappedValue(targetColumn, originalValue)`: 코드값(`ID`)을 화면표시값(`Name`)으로 변환.
*   `getReferenceOptions(targetColumn)`: 드롭다운(Select) 생성을 위한 참조 데이터 리스트 반환.
*   `reloadRefData()`: 참조 데이터를 서버에서 다시 불러오는 함수 (새로고침용).

---

## 3. 적용 방법 (Component Integration)

`Investment.jsx` 등의 컴포넌트에서 사용하는 방법입니다.

### 3.1. Hook 초기화
```javascript
import { useDataMapper } from './hooks/useDataMapper';

// 컴포넌트 내부
const { 
  getMappedValue, 
  getReferenceOptions, 
  reloadRefData 
} = useDataMapper('ACCOUNTS_MANAGER'); // mapping_rules.js에 정의된 View ID 사용
```

### 3.2. 데이터 조회/표시 (Table, Read-only)
테이블 셀 등에서 원본 값을 변환하여 표시할 때 사용합니다.
```javascript
// 예: account_type 컬럼 렌더링 시
<td>
  {getMappedValue('account_type', row.account_type)}
</td>
```

### 3.3. 필터 및 입력 폼 (Select Box)
드롭다운 옵션을 동적으로 생성할 때 사용합니다.
```javascript
// 예: 필터 Select Box
<select>
  {getReferenceOptions('account_type').map(option => (
    <option key={option.code_id} value={option.code_id}>
      {option.code_name}
    </option>
  ))}
</select>
```
> **주의:** `getReferenceOptions`가 반환하는 객체의 키(`code_id`, `code_name`)는 `mapping_rules.js`의 `refKey`, `displayColumn` 설정에 따라 달라질 수 있습니다.

### 3.4. 데이터 최신화 (Reload)
탭 전환이나 조회 버튼 클릭 시, 참조 데이터가 오래된 경우를 방지하기 위해 리로드를 호출합니다.
```javascript
useEffect(() => {
  if (activeTab === 'accounts_code_mapped') {
    reloadRefData();
  }
}, [activeTab, reloadRefData]);
```

---

## 4. 현재 적용 현황

### 4.1. 계좌 관리 (코드) 탭
*   **View ID**: `ACCOUNTS_MANAGER`
*   **매핑 내용**: `CODES` 시트의 `ACCOUNT_TYPE` 그룹을 참조하여 계좌 유형을 표시.
*   **특이사항**: 코드 관리 화면에서 코드 수정 후 탭 진입 시 자동 반영됨.

### 4.2. 투자내역 조회/추가 탭
*   **View ID**: `INVESTMENT_LIST`
*   **매핑 내용**: `accounts_master` 시트를 참조하여 `category`(계좌ID)를 `account_name`으로 표시.
*   **특이사항**: 투자내역 추가 시에도 최신 계좌 목록이 드롭다운에 표시됨.
